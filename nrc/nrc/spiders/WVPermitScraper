# WV Well Permit Scraper

import re
from datetime import datetime, timedelta
import xlrd
import uuid
from string import Template
from xml.sax.saxutils import escape

from scrapy.spider import BaseSpider
from scrapy.contrib.loader import ItemLoader
from scrapy.http import Request, Response, TextResponse
from scrapy.contrib.loader.processor import TakeFirst, MapCompose, Join
from scrapy.shell import inspect_response
from scrapy import log
from scrapy.stats import stats

from nrc.items import PA_DrillingPermit, FeedEntry, FeedEntryTag
from nrc.database import NrcDatabase
from nrc.NrcBot import NrcBot
from nrc.ExcelScraper import ExcelScraper


class WVPermitScraper (ExcelScraper):
    name = 'WVPermitScraper'
    allowed_domains = None


    def process_item(self, task):

        request = Request (task['target_url'], callback=self.parse_excel)
        self.log('Downloading excel file from url %s' % (task['target_url']), log.INFO)
        request.meta['task'] = task
        yield request


    def process_row (self, row, task):

        l=ItemLoader (PA_DrillingPermit())
        l.add_value (None, row)
        item = l.load_item()
        if item['Complete_API_'] and item ['Date_Disposed']:
            existing_item = self.db.loadItem (item, {'Complete_API_': item['Complete_API_'], 'Date_Disposed': item ['Date_Disposed']})
            
            if existing_item:
#                diff = item.contentDiff (existing_item)
    
#                if diff:
#                    self.send_alert ('PA Permit values in %s have changed since previous scrape\n\n%s' % (item, diff))
#                    self.log ('PA Permit values in %s have changed since previous scrape\n\n%s' % (item, diff), log.ERROR)
#                    stats.inc_value ('_error_count', spider=self)
#                else:
#                    self.log('Skipping existing item %s' % (item), log.DEBUG)
#                    stats.inc_value ('_unchanged_count', spider=self)

                stats.inc_value ('_existing_count', spider=self)
            else:
                stats.inc_value ('_new_count', spider=self)
                yield item
                
                params = dict(item)
                for f in item.fields:
                    params[f] = escape ("%s" % params.get(f,''))
                                    
                params['Appl_Type_Code'] = self.get_appl_type(item)
                params['Well_Type'] = self.get_well_type(item)

                # create a new feed item
                l=ItemLoader (FeedEntry())
                
                url = "%s/%s/%s" % (task['target_url'], item['Complete_API_'], item ['Date_Disposed'])
                feed_entry_id = uuid.uuid3(uuid.NAMESPACE_URL, url.encode('ASCII'))
                l.add_value ('id', feed_entry_id)
                l.add_value ('title', "PA %s Drilling Permit Issued in %s Township" % (params.get('Well_Type'), item.get('Municipality_Name') ))
#                l.add_value ('updated', item.get('Date_Disposed'))
                l.add_value ('incident_datetime', item.get('Date_Disposed'))
                l.add_value ('link', task['about_url'])

                
                l.add_value ('summary', self.summary_template().substitute(params))
                l.add_value ('content', self.content_template().substitute(params))
                
                l.add_value ('lat', item.get('Latitude_Decimal'))
                l.add_value ('lng', item.get('Longitude_Decimal'))
                l.add_value ('source_id', 4)
                
                feed_item = l.load_item()
                
                if feed_item.get('lat') and feed_item.get('lng'):
                    yield feed_item
                    
                    yield self.create_tag (feed_entry_id, 'frack')
                    yield self.create_tag (feed_entry_id, 'permit')
                    if item.get('Marcellus_Shale_Well') == 'Y':
                        yield self.create_tag (feed_entry_id, 'marcellus')
                    well_type = params.get('Well_Type')
                    if well_type:
                        yield self.create_tag (feed_entry_id, well_type)
                    

    def create_tag (self, feed_entry_id, tag, comment = ''):                                    
        l = ItemLoader (FeedEntryTag())
        l.add_value ('feed_entry_id', feed_entry_id)
        l.add_value ('tag', tag)
        l.add_value ('comment', comment)
        return l.load_item()

    def item_stored(self, item, id):
        self.item_new (id)
        pass

    def get_appl_type (self, item):
        m = {'NEW': 'New', 'REN': 'Renewal'}
        code = item.get('Appl_Type_Code')
        return m.get(code, code)

    def get_well_type (self, item):
        m = {'GAS': 'Gas', 'OIL': 'Oil'}
        code = item.get('Well_Type')
        return m.get(code, code)

    def summary_template (self):
        return Template ("$Well_Type permit issued on $Date_Disposed to $Operator for site $Site_Name in $Municipality_Name township, $County_Name county")

        
    def content_template (self):
        return Template (
"""<b>Report Details</b><br/>
Well Type: $Well_Type <br/>
Permit Issued: $Date_Disposed <br/>
Operator: $Operator <br/>
Site Name: $Site_Name <br/>
Township: $Municipality_Name <br/>
County: $County_Name <br/>
Permit Type: $Appl_Type_Code <br/>
Description: $Auth_Type_Description <br/>
Marcellus Shale: $Marcellus_Shale_Well <br/>
Horizontal: $Horizontal_Well <br/>
Total Depth : $Total_Depth <br/>
Well API Number: $Complete_API_ <br/>
""")        

    